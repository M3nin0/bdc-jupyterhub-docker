version: '3.2'

services:
    jupyterhub:
        build:
            context: ./docker/
            args:
                BASE_IMAGE: jupyterhub/jupyterhub:1.3.0
        image: brazildatacube/jupyterhub:1.0.0
        container_name: bdc-jupyterhub
        hostname: bdc-jupyterhub
        volumes:
            -   type: bind
                source: ./config/jupyterhub_config.py
                target: /srv/jupyterhub/jupyterhub_config.py
            -   type: bind
                source: ./config/users.json
                target: /srv/jupyterhub/users.json
            -   type: bind
                source: ./config/images.json
                target: /srv/jupyterhub/images.json
            -   type: bind
                source: /var/run/docker.sock
                target: /var/run/docker.sock
            -   type: volume
                source: jupyterhub_data
                target: "/srv/jupyterhub"
            -   type: bind
                source: ${USERS_BASE_DIR_SOURCE}
                target: ${USERS_BASE_DIR_TARGET}
        env_file:
            - ./.env
        environment:
            - HOST
        restart: unless-stopped
        networks:
            - bdc-jupyterhub-net

    nginx:
        image: nginx:1.21.3
        container_name: jupyterhub-nginx
        hostname: jupyterhub-nginx
        restart: unless-stopped
        volumes:
            - "./nginx/conf/default.conf:/etc/nginx/conf.d/default.conf:ro"
            - "./nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro"
            - "./nginx/ssl:/certs:ro"
            - "./nginx/log:/var/log/nginx-fs"
        networks:
            - bdc-jupyterhub-net
        ports:
            - "443:443"
        env_file:
            - ./.env
        depends_on:
            - "jupyterhub"

volumes:
  jupyterhub_data:

networks:
    bdc-jupyterhub-net:
        external:
            name: ${DOCKER_NETWORK_NAME}
